<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Your current credit card can be used in four different ways:
Typing in the card number. We&rsquo;ve been using credit cards this way since 1950. Sliding the card&rsquo;s magnetic strip (the black stripe) through a card reader. This method was invented by IBM in the 1960s and has been in use ever since, but it&rsquo;s on its way out. In a few short years many credit cards will no longer have a magnetic strip.'>

<meta property='og:title' content='Credit card chips and encryption in plain JavaScript • Minimum Viable Blog'>
<meta property='og:description' content='Your current credit card can be used in four different ways:
Typing in the card number. We&rsquo;ve been using credit cards this way since 1950. Sliding the card&rsquo;s magnetic strip (the black stripe) through a card reader. This method was invented by IBM in the 1960s and has been in use ever since, but it&rsquo;s on its way out. In a few short years many credit cards will no longer have a magnetic strip.'>
<meta property='og:url' content='http://isaaclyman.com/blog/posts/credit-card-microchip/'>
<meta property='og:site_name' content='Minimum Viable Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:published_time' content='2022-10-25T12:23:02-06:00'/><meta property='article:modified_time' content='2022-10-25T12:23:02-06:00'/>

<meta name="generator" content="Hugo 0.124.1">

  <title>Credit card chips and encryption in plain JavaScript • Minimum Viable Blog</title>
  <link rel='canonical' href='http://isaaclyman.com/blog/posts/credit-card-microchip/'>
  
  <link rel='icon' href='/blog/favicon.png'>
<link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Ubuntu:400,400i,700&subset=latin'>
<link rel='stylesheet' href='/blog/css/main.d02777fd.css'>

  <link rel='stylesheet' href='/blog/css/custom.css'>

  <link rel='stylesheet' href='/blog/css/print.css'>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-QX2T3WXRC9"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-QX2T3WXRC9', { 'anonymize_ip': false });
}
</script>


</head>


<body class='page'>
  <div class='site'>
    <header id='header' class='header-container'>
      <div class='site-header'>
        <nav id='navmenu' aria-label='Main Menu'>
  <ul class='main-menu'>
    
    <li>
      <a href='/blog/posts/' 
        
      >{ Archive }</a>
    </li>
    
    <li>
      <a href='/blog/posts/introduction' 
        
      >{ Contact }</a>
    </li>
    
    <li>
      <a href='/blog/index.xml' 
        
      >{ RSS }</a>
    </li>
    
  </ul>
</nav>

        <div class='site-info'>
          
          <p class='site-title title'>Minimum Viable Blog</p>
          
          <p class='site-description'>Software construction, opinion, and self</p>
        </div>
      </div>
    </header>


<main class='main'>
  <article lang='en' class='entry'>
    <header class='entry-header'>
  <div class='entry-info'>
    <p class="entry-genre">
      Technology
    </p>
    <h1 class='entry-title title'>Credit card chips and encryption in plain JavaScript</h1>
    
  </div>
  
<div class='meta'>
  <span class='posted-on'>
    <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>

    <span class='screen-reader'>Posted on </span>
    <time class='date' datetime='2022-10-25T12:23:02-06:00'>Oct 25, 2022</time>
  </span>
  
  
  <span class='reading-time'>
    <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/> 
  
</svg>

    16 mins read
  </span>
  
</div>


</header>

    <div class='entry-content'>
  <p>Your current credit card can be used in four different ways:</p>
<ol>
<li><strong>Typing in the card number.</strong> We&rsquo;ve been using credit cards this way since 1950.</li>
<li><strong>Sliding the card&rsquo;s magnetic strip</strong> (the black stripe) through a card reader. This method was invented by IBM in the 1960s and has been in use ever since, but it&rsquo;s on its way out. <a href="https://www.mastercard.com/news/perspectives/2021/magnetic-stripe/">In a few short years</a> many credit cards will no longer have a magnetic strip. With luck, we&rsquo;ll phase them out completely sometime in the 2030s.</li>
<li><strong>Inserting the card</strong> into a chip reader. Chip cards were first invented in the 1960s, believe it or not. France and Germany developed standards for them in the 1980s, but it took until the 2000s for a worldwide standard (EMV) to catch on, and the U.S. didn&rsquo;t start issuing chip cards until the mid-2010s. By now, every major credit card has a microchip in it.</li>
<li><strong>Waving the card</strong> over a contactless chip reader. This is essentially the same as inserting the card and uses the same embedded microchip.</li>
</ol>
<p>Today I&rsquo;ll be going in-depth on these last two, explaining what the &ldquo;chip&rdquo; on your card is and how it works. The technology involved is closely related to the tech that keeps web browsing and app downloads secure.</p>
<h2 id="the-microchip">The microchip</h2>
<p>You&rsquo;ve no doubt noticed the shiny metal chip on the front of your credit card. Except that&rsquo;s not a chip; it&rsquo;s an electrical contact. When you insert your card, electricity is supplied through the contact&rsquo;s <a href="https://pinoutguide.com/Memory/SmartCardIso_pinout.shtml">top left pin</a> to power the <em>actual</em> microchip, which is embedded inside the card, and other pins are used to communicate between the microchip and the payment terminal. If your card is &ldquo;tap to pay&rdquo; enabled, it also has an antenna around the inside edge that receives wireless power and communicates with the card reader via radio waves.</p>
<p>To be clear, the microchip on your credit card is a computer! No, really. It&rsquo;s a very small computer that runs one or more applications. So that&rsquo;s cool. You&rsquo;re probably carrying two or three computers in your wallet right now.</p>
<p>Why does your credit card need an onboard computer? Isn&rsquo;t that going overboard?</p>
<p>Think about how easy it is to steal someone&rsquo;s credit card information right now. A quick photo will do it. The card&rsquo;s &ldquo;passwords&rdquo;—a name, 16-digit number, expiration date, and security code—are all clearly displayed. Many of us have had the unpleasant experience of discovering someone else is using our credit card number and we don&rsquo;t even know how they got it. In fact, <a href="https://twitter.com/patio11/status/1465718845147021316">there&rsquo;s a thriving industry</a> around credit card fraud: companies that buy and sell stolen numbers, other companies that test them to see if they still work, and tens of billions of dollars circulating between them and an army of online and offline thieves.</p>
<p>Even if the card were blank except for the magnetic strip, it would still be a relatively easy target. A credit card&rsquo;s number never changes. And reading magnetic strips is decades-old technology, so simple it can be done by a device even smaller than a credit card (including onboard memory). Devices like these (called &ldquo;skimmers&rdquo;) are commonly inserted in gas station card readers and left to collect data for a couple days before being retrieved. So neither credit card numbers nor magnetic strips are up to the task of protecting your financial identity.</p>
<p>This is a problem well worth solving. But credit cards need to identify themselves <em>somehow</em>. The card reader at the grocery store has to tell your bank how much you&rsquo;re spending, and the bank needs to deduct money from your account. If a hacker is listening in on that electronic conversation, how can we stop them from learning enough to use your card for fraud?</p>
<p>That&rsquo;s very similar to another topic I&rsquo;ve written about: <a href="https://isaaclyman.com/blog/posts/https/">how HTTPS stops hackers from reading the information you send over the Internet</a>. When you visit a website, your browser and the website establish a secret decoding key together, <em>in the open</em>, and nobody else can figure out what it is even if they&rsquo;re listening the whole time. That&rsquo;s the magic of prime numbers.</p>
<p>So is your credit card doing an HTTPS key exchange with the bank? Well, not quite.</p>
<h2 id="encryption-and-symmetry">Encryption and symmetry</h2>
<p>If you&rsquo;ve ever written to a friend in a made-up language or used a numeric code (A=1, B=2, C=3&hellip;) you understand the concept of encryption. Encryption is taking a message and disguising it with some kind of algorithm; decryption is reversing the algorithm to decode it and see the original message. Nowadays we encrypt nearly everything online. We might as well; it&rsquo;s fast and free, and it&rsquo;s always better to err on the side of privacy.</p>
<p>Sometimes we need to encrypt something so hard it can never be decrypted. We do this for passwords (or try to). There&rsquo;s absolutely no reason for anyone but you to know your password. The websites you log into store an irreversibly encrypted <em>hash</em> of your password, then use that hash for comparison every time you log in. They don&rsquo;t know your password, but they can check to see if you&rsquo;re typing the right one.</p>
<p>This isn&rsquo;t one of those times. Your credit card needs to supply a piece of information that the bank (but nobody else) can quickly decrypt.</p>
<p>One way to do this is by using <em>symmetric key encryption</em> (also called <em>private key encryption</em>). This requires the credit card and the bank to have a shared, predetermined <em>key</em>: a string of bytes that can be used to encrypt or decrypt any message. That&rsquo;s no problem, since the card came from the bank in the first place; they can program the key into the card before they mail it to you.</p>
<p>Let&rsquo;s implement a two-round symmetric key encryption algorithm in JavaScript. It will be far too simple and insecure to use in real life, but it&rsquo;ll illustrate how an algorithm like AES works. We&rsquo;ll be using the bitwise XOR operator <code>^</code>, which you probably don&rsquo;t see very often, but all you need to know is if <code>a ^ b === c</code>, then <code>c ^ a === b</code> and <code>c ^ b === a</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// ENCRYPTION
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// This is the entry point. It converts your shared key to a number
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//  and your message to an array of numbers, then encrypts it in two
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//  steps. It converts the resulting array of numbers back to a string
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//  and returns it.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">function</span> encrypt(sharedKey, message) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> numericKey <span style="color:#ff79c6">=</span> stringKeyToNumeric(sharedKey)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> messageBytes <span style="color:#ff79c6">=</span> stringToIntArray(message)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> r1 <span style="color:#ff79c6">=</span> encryptRound1(numericKey, messageBytes)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> r2 <span style="color:#ff79c6">=</span> encryptRound2(numericKey, r1)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> encrypted <span style="color:#ff79c6">=</span> intArrayToString(r2)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> encrypted
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> encryptRound1(numericKey, byteArray) {
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// Create a &#34;round key&#34; so we aren&#39;t using the same key for every step
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">const</span> roundKey <span style="color:#ff79c6">=</span> numericKey <span style="color:#ff79c6">^</span> <span style="color:#bd93f9">4321</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// For each character in the message, XOR it with the round key
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">return</span> byteArray.map(<span style="color:#ff79c6">byte</span> =&gt; <span style="color:#ff79c6">byte</span> <span style="color:#ff79c6">^</span> roundKey)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> encryptRound2(numericKey, byteArray) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> roundKey <span style="color:#ff79c6">=</span> numericKey <span style="color:#ff79c6">%</span> <span style="color:#bd93f9">1234</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> newBytes <span style="color:#ff79c6">=</span> byteArray.slice()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// &#34;Rotate&#34; the array (move the last element to the beginning) roundKey times
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">let</span> step <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; step <span style="color:#ff79c6">&lt;</span> roundKey; step<span style="color:#ff79c6">++</span>) {
</span></span><span style="display:flex;"><span>    newBytes.unshift(newBytes.pop())
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> newBytes
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// DECRYPTION
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// The other entry point. It does the same thing as `encrypt` but backwards.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">function</span> decrypt(sharedKey, encrypted) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> numericKey <span style="color:#ff79c6">=</span> stringKeyToNumeric(sharedKey)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> messageBytes <span style="color:#ff79c6">=</span> stringToIntArray(encrypted)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> r1 <span style="color:#ff79c6">=</span> decryptRound1(numericKey, messageBytes)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> r2 <span style="color:#ff79c6">=</span> decryptRound2(numericKey, r1)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> message <span style="color:#ff79c6">=</span> intArrayToString(r2)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> message
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> decryptRound1(numericKey, byteArray) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> roundKey <span style="color:#ff79c6">=</span> numericKey <span style="color:#ff79c6">%</span> <span style="color:#bd93f9">1234</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> newBytes <span style="color:#ff79c6">=</span> byteArray.slice()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// &#34;Unrotate&#34; the array roundKey times
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">let</span> step <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; step <span style="color:#ff79c6">&lt;</span> roundKey; step<span style="color:#ff79c6">++</span>) {
</span></span><span style="display:flex;"><span>    newBytes.push(newBytes.shift())
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> newBytes
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> decryptRound2(numericKey, byteArray) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> roundKey <span style="color:#ff79c6">=</span> numericKey <span style="color:#ff79c6">^</span> <span style="color:#bd93f9">4321</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// XOR each character with the same round key, which gives us the original
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">return</span> byteArray.map(<span style="color:#ff79c6">byte</span> =&gt; <span style="color:#ff79c6">byte</span> <span style="color:#ff79c6">^</span> roundKey)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// UTILITY
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> stringToIntArray(message) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> message.split(<span style="color:#f1fa8c">&#39;&#39;</span>).map(<span style="color:#ff79c6">char</span> =&gt; <span style="color:#ff79c6">char</span>.charCodeAt(<span style="color:#bd93f9">0</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> intArrayToString(intArray) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> intArray.map(<span style="color:#ff79c6">int</span> =&gt; <span style="color:#8be9fd;font-style:italic">String</span>.fromCharCode(<span style="color:#ff79c6">int</span>)).join(<span style="color:#f1fa8c">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> stringKeyToNumeric(key) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> fourDigitCodes <span style="color:#ff79c6">=</span> key.split(<span style="color:#f1fa8c">&#39;&#39;</span>).map(<span style="color:#ff79c6">char</span> =&gt; <span style="color:#ff79c6">char</span>.charCodeAt(<span style="color:#bd93f9">0</span>).toString().padStart(<span style="color:#bd93f9">4</span>, <span style="color:#f1fa8c">&#39;0&#39;</span>))
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> numericKey <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">Number</span>(fourDigitCodes.join(<span style="color:#f1fa8c">&#39;&#39;</span>))
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> numericKey
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// TEST PROGRAM
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> message <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Hello there.&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> sharedKey <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;ABCDEF&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>console.log(<span style="color:#f1fa8c">&#39;Message:&#39;</span>, message) <span style="color:#6272a4">// =&gt; Message: Hello there.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> encrypted <span style="color:#ff79c6">=</span> encrypt(sharedKey, message)
</span></span><span style="display:flex;"><span>console.log(<span style="color:#f1fa8c">&#39;Encrypted:&#39;</span>, encrypted) <span style="color:#6272a4">// =&gt; Encrypted: ႎჁ႕ႉႄ႓ႄ჏Ⴉႄႍႍ
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> decrypted <span style="color:#ff79c6">=</span> decrypt(sharedKey, encrypted)
</span></span><span style="display:flex;"><span>console.log(<span style="color:#f1fa8c">&#39;Decrypted:&#39;</span>, decrypted) <span style="color:#6272a4">// =&gt; Decrypted: Hello there.
</span></span></span></code></pre></div><p>Go ahead, paste this into a REPL and play with it if you&rsquo;d like.</p>
<p>Some of you might be saying &ldquo;<em>this</em> is what you call simple?!&rdquo; And others might be saying &ldquo;this is way too simple, where are the lookup tables and block ciphers?&rdquo; Look, I can&rsquo;t please everyone but I <em>can</em> upset everyone, so that&rsquo;s what I went with.</p>
<p>Let&rsquo;s put this code in context. If my credit card&rsquo;s microchip has the shared key <code>&quot;ABCDEF&quot;</code> programmed into it and my bank knows to use that key for messages that come from me, here&rsquo;s a simplified example of how a purchase authorization might go:</p>
<blockquote>
<p><strong>Payment terminal:</strong> I&rsquo;m verifying a purchase of four chinchillas at Pet Central for 89.99 USD at 11:15 PM, Oct 10 2022. Please respond.</p>
<p><strong>Microchip:</strong> Okay. I&rsquo;ve received the transaction but I&rsquo;ll need a PIN number to authorize it.</p>
<p><strong>Payment terminal:</strong> Sure thing. Customer, please enter your PIN.</p>
<p><strong>Me:</strong> *Types 9999.*</p>
<p><strong>Payment terminal:</strong> Is that the right PIN, microchip?</p>
<p><strong>Microchip:</strong> Yep, that&rsquo;s the one. I trust this transaction. <code>encrypt(&quot;ABCDEF&quot;, &quot;Pet Central: 89.99 USD at 11:15 PM, Oct 10 2022&quot;)</code>&hellip;done. The transaction has been encrypted with my private key. Please send it to FIRST BANK and tell them it&rsquo;s from ISAAC LYMAN, whose account number is 12345678.</p>
<p><strong>Payment terminal:</strong> Great. Contacting the bank&hellip;</p>
<p><strong>FIRST BANK:</strong> Hello, FIRST BANK speaking.</p>
<p><strong>Payment terminal:</strong> I&rsquo;m a payment terminal at Pet Central. I want to process a transaction for account 12345678 under the name ISAAC LYMAN.</p>
<p><strong>FIRST BANK:</strong> Transaction received. <code>decrypt(&quot;ABCDEF&quot;, transaction)</code>&hellip;and done. I can verify this transaction is from ISAAC LYMAN&rsquo;s credit card because otherwise it wouldn&rsquo;t decrypt. Everything lines up, so I&rsquo;ll deduct 89.99 USD from his account and send it over.</p>
<p><strong>Payment terminal:</strong> Transaction successful.</p>
</blockquote>
<p>Note that my credit card number doesn&rsquo;t have to be sent over the wire. Neither does my private key. In fact, nothing worth stealing is leaving the terminal. A hacker could grab the encrypted transaction message, but there&rsquo;s no way to use it unless they have a time machine and want to buy four chinchillas from Pet Central at the exact same time I originally bought them.</p>
<p>Symmetric key encryption is used by some banks, but it has a couple of minor flaws. One of them is that theoretically, the bank could make up a fake transaction and charge you for it. They&rsquo;ve got your private key, so the only thing stopping them is hundreds of international regulations. The other flaw is that your private key is stored on an Internet-connected server at the bank, so it could be stolen if there&rsquo;s a security breach.</p>
<p>To be clear: symmetric key encryption is <em>so much better</em> than credit card numbers and magnetic strips. But there&rsquo;s an even better way.</p>
<h2 id="asymmetric-keys">Asymmetric keys</h2>
<p>Symmetric keys make a lot of sense. <em>Of course</em> if you and another person have a shared secret key, you can encrypt and decrypt each other&rsquo;s messages.</p>
<p>Asymmetric keys step into the realm of magic. Or, at least, counterintuitive math.</p>
<p>In asymmetric encryption, there are two different keys: a private key and a public key. These keys are mathematically related, but knowing one won&rsquo;t help you figure out the other. They serve opposite functions: you can encrypt a message with the private key that can only be decrypted by the public key, and you can encrypt a message with the public key that can only be decrypted by the private key.</p>
<p>Asymmetric encryption is often used by journalists for sensitive investigations. They can generate a key pair, store the private key on a device they trust, and post the public key for the whole world to see. Anyone who wants to send them a secret message can use the public key to encrypt it, ensuring only the journalist will be able to decrypt it. And in the opposite direction, the journalist can encrypt a message using their private key (or encrypt a hash of it, which we call &ldquo;signing&rdquo; it), which provides proof of authorship. If the message (or hash) can be decrypted using their public key, that proves it came from them.</p>
<p>Back to credit cards. The bank can program a public/private key pair onto your credit card and then <em>completely forget</em> the private key. They don&rsquo;t need to store it anywhere. They only need to hold onto the public key. They&rsquo;ll use it for two purposes: to decrypt messages sent from your card <em>and</em> to prove those messages came from you, not them.</p>
<p>This eliminates the first risk of symmetric keys: fraud committed by the bank itself. As long as they can prove they didn&rsquo;t keep your private key after they programmed your card, they can&rsquo;t be accused of generating fake transactions. It also eliminates the second risk. Your private key isn&rsquo;t stored on any Internet-connected server; it only lives in one place in the entire world, and that&rsquo;s inside your credit card. Sure, your public key could be stolen. But the only thing the thieves could do with it is read your transactions. They wouldn&rsquo;t be able to create new ones.</p>
<p>Let&rsquo;s implement some asymmetric encryption in JavaScript. This will illustrate how an algorithm like RSA works.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// ENCRYPTION
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> encrypt(privateKey, message) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> messageBytes <span style="color:#ff79c6">=</span> stringToIntArray(message)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> [modulus, exponent] <span style="color:#ff79c6">=</span> privateKey
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> encrypted <span style="color:#ff79c6">=</span> messageBytes.map(<span style="color:#ff79c6">byte</span> =&gt; (BigInt(<span style="color:#ff79c6">byte</span>) <span style="color:#ff79c6">**</span> exponent) <span style="color:#ff79c6">%</span> modulus)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> intArrayToString(encrypted)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// DECRYPTION
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> decrypt(publicKey, encrypted) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> encryptedBytes <span style="color:#ff79c6">=</span> stringToIntArray(encrypted)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> [modulus, exponent] <span style="color:#ff79c6">=</span> publicKey
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> decrypted <span style="color:#ff79c6">=</span> encryptedBytes.map(<span style="color:#ff79c6">byte</span> =&gt; (BigInt(<span style="color:#ff79c6">byte</span>) <span style="color:#ff79c6">**</span> exponent) <span style="color:#ff79c6">%</span> modulus)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> intArrayToString(decrypted)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// UTILITY
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> stringToIntArray(message) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> message.split(<span style="color:#f1fa8c">&#39;&#39;</span>).map(<span style="color:#ff79c6">char</span> =&gt; <span style="color:#ff79c6">char</span>.charCodeAt(<span style="color:#bd93f9">0</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> intArrayToString(intArray) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> intArray.map(<span style="color:#ff79c6">int</span> =&gt; <span style="color:#8be9fd;font-style:italic">String</span>.fromCharCode(<span style="color:#8be9fd;font-style:italic">Number</span>(<span style="color:#ff79c6">int</span>))).join(<span style="color:#f1fa8c">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// TEST PROGRAM
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/* 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  Each key has two parts: a shared &#34;modulus&#34; and a non-shared &#34;exponent.&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  Key generation is complex. These three numbers all have to be mathematically related.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  In real life the modulus would be a very large number in the ballpark of
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  5353683424958100487553692737855921351167231508809347122534824314767512079033611122618
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  8508861310385963124739442570162267402922655660049366578306762217485423974277904708682
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  5660398049299993503929195152693455928734884540497474885533510411221183157745113097158
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  7147857841470416503261588799943431828622126181414376019549024568602030872555448200000
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  2641304272163777569374865564566594216223640291860534772832785404395599963806669068407
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  0321707428203752195331410456415056194233539898345799623002726720980709094812380346346
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  3583607751796240362096547051130726215056560026642532836575212569426651466587428695230
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  1071376112504419090641365.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  The exponents would be somewhat smaller. Both exponents must be prime numbers.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  We use the `n` suffix to get BigInts, since playing with exponents can exceed
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  JavaScript&#39;s standard number limit pretty quickly.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> privateKey <span style="color:#ff79c6">=</span> [<span style="color:#bd93f9">25777</span>n, <span style="color:#bd93f9">3</span>n]
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> publicKey <span style="color:#ff79c6">=</span> [<span style="color:#bd93f9">25777</span>n, <span style="color:#bd93f9">16971</span>n]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> message <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Four chinchillas&#34;</span>
</span></span><span style="display:flex;"><span>console.log(<span style="color:#f1fa8c">&#34;Message:&#34;</span>, message) <span style="color:#6272a4">// =&gt; Message: Four chinchillas
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> encrypted <span style="color:#ff79c6">=</span> encrypt(privateKey, message)
</span></span><span style="display:flex;"><span>console.log(<span style="color:#f1fa8c">&#34;Encrypted:&#34;</span>, encrypted) <span style="color:#6272a4">// =&gt; Encrypted: ớ֪൯⿟᭏䂦䁅宍㿵䂦䁅宍垐垐⣮ 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> decrypted <span style="color:#ff79c6">=</span> decrypt(publicKey, encrypted)
</span></span><span style="display:flex;"><span>console.log(<span style="color:#f1fa8c">&#34;Decrypted:&#34;</span>, decrypted) <span style="color:#6272a4">// =&gt; Decrypted: Four chinchillas
</span></span></span></code></pre></div><p>A few things you might be thinking at this point:</p>
<ul>
<li><em>Wait, this is <strong>shorter</strong> than the other code snippet.</em> If that doesn&rsquo;t seem right, it&rsquo;s because it isn&rsquo;t. This is only the asymmetric part. In real life you&rsquo;d do some reversible encryption (&ldquo;padding&rdquo;) rounds before you use your asymmetric key so the encrypted text couldn&rsquo;t be cracked by a letter-frequency attack. But that&rsquo;s not the whole story either. Typically a message sender asymmetrically encrypts a randomly-generated key, uses that key to <em>symmetrically</em> encrypt the message, and sends the symmetrically encrypted message and asymmetrically encrypted key together. (This is because symmetric encryption is faster.)</li>
<li><em>Hey, this looks a lot like a Diffie-Hellman key exchange!</em> Well, that&rsquo;s because in both cases we&rsquo;re looking for a computation that&rsquo;s easy to do but hard to reverse, and we&rsquo;re looking for a way to encrypt and decrypt a message using numeric counterparts. Prime numbers are easy to multiply and the result is hard to factor—that&rsquo;s part one. And part two: exponents and moduluses have mystical properties that allow numbers to travel between dimensions unharmed.</li>
<li><em>Good grief, this is complicated.</em> And that&rsquo;s why you should never do it yourself. Make even one tiny mistake and your security goes down the drain. You should always use a popular, well-vetted cryptography library in whatever language you&rsquo;re programming in. This bears repeating: <strong>never implement an encryption algorithm on your own.</strong></li>
</ul>
<p>Some banks use asymmetric key pairs in credit card chips. This creates an opportunity for a few extra security features. For example, if the bank has their own public/private key pair, they can publish their public key and use their private key to sign <em>your</em> public key, which creates a chain of evidence linking your card to them. When you use your card, it can send its public key to the terminal with a cryptographic signature from the bank proving they issued it! The payment terminal just needs to know the bank&rsquo;s public key to verify the signature. Then when the card signs a transaction, the terminal can check that it matches the signed public key. This allows offline, computational assurance that a card is authentic.</p>
<p>Unfortunately, complete security is impossible. A computer is only secure until it gets into the wrong hands. Your card&rsquo;s microchip is engineered not to reveal its private key, but all bets are off when it comes to physical access. So if you lose your wallet, you still need to call your bank.</p>
<h2 id="the-future-of-credit-cards">The future of credit cards</h2>
<p>Many stores are reluctant to upgrade their payment terminals—it&rsquo;s a hard cost with fuzzy benefits—but most of them did so in 2015, when card issuers updated their agreements to make stores liable for credit card fraud if their terminals didn&rsquo;t have EMV chip readers. Liability is a powerful force in the business world. So now most of the places you shop let you insert your card&rsquo;s microchip to pay, and quite a few also have contactless tap-to-pay terminals.</p>
<p>What&rsquo;s next?</p>
<p>It would be great to get rid of visible credit card numbers and magnetic strips. The credit card fraud industry would be left gasping for air. One major holdout is online shopping. You still have to type in your name, card number, expiration date, and CVV code to buy something from a website. But the world is ripe for change; most smartphones made in the last five years have NFC chips, and roughly half of all e-commerce happens on smartphones. So with a little work on the software side, it&rsquo;s not hard to imagine a world where you could pay for something by waving your credit card over your phone screen.</p>
<p>Then again, that may be too many steps. Both iPhone and Android have mobile wallet functionality so you can program your cards into your phone and use your phone to pay both in-person (at tap-to-pay terminals) and at some online stores. This doesn&rsquo;t need to go away; perhaps there&rsquo;s a version of the future where you add cards to your mobile wallet using a direct connection to the issuing bank instead of a few easily-stolen strings of digits.</p>
<p>The ideal credit card would be one that couldn&rsquo;t be used fraudulently unless it was physically stolen by someone with advanced technology and plenty of time on their hands. You couldn&rsquo;t reveal its secrets to a scam caller even if you wanted to.</p>
<p>Like so many other things, we&rsquo;ll leave it in the capable hands of a microchip.</p>
<h2 id="acknowledgments">Acknowledgments</h2>
<p>Thanks to the following authors, without whose work I wouldn&rsquo;t understand this subject at all:</p>
<ul>
<li>Daniel Cuthbert, <a href="https://www.the-parallax.com/emv-chip-credit-card/"><em>Behind the chip on your credit card</em></a></li>
<li>Nadia Heninger, <a href="https://cseweb.ucsd.edu/classes/wi22/cse127-a/scribenotes/13-symmetriccrypto-notes.pdf"><em>Symmetric Cryptography</em></a></li>
<li>Vicki Hyman, <a href="https://www.mastercard.com/news/perspectives/2021/magnetic-stripe/"><em>Swiping left on magnetic stripes</em></a></li>
<li>David Ireland, <a href="https://www.di-mgt.com.au/rsa_alg.html"><em>RSA Algorithm</em></a></li>
<li>Tom Leek, <a href="https://security.stackexchange.com/a/49294/201074"><em>Exact cryptography depends on&hellip;</em></a></li>
<li>EMVCo, LLC, <a href="https://www.emvco.com/wp-content/uploads/2017/05/A_Guide_to_EMV_Chip_Technology_v2.0_20141120122132753.pdf"><em>A Guide to EMV Chip Technology</em></a></li>
<li>Wikipedia.org: <a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard"><em>Advanced Encryption Standard</em></a>, <a href="https://en.wikipedia.org/wiki/Contactless_smart_card"><em>Contactless smart card</em></a>, <a href="https://en.wikipedia.org/wiki/Digital_signature"><em>Digital signature</em></a>, <a href="https://en.wikipedia.org/wiki/EMV"><em>EMV</em></a>, <a href="https://en.wikipedia.org/wiki/Public-key_cryptography"><em>Public-key cryptography</em></a>, <a href="https://en.wikipedia.org/wiki/RSA_(cryptosystem)"><em>RSA (cryptosystem)</em></a></li>
</ul>

</div>

    
<footer class='entry-footer'>
  
    
      
      

<div class='categories'>
  <span class='category-icon'>
    <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M22,19a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V5A2,2,0,0,1,4,3H9l2,3h9a2,2,0,0,1,2,2Z"/>
  
</svg>

  </span>
  <span class='screen-reader'>Categories: </span><a class='category' href='/blog/categories/development'>development</a></div>

    
  
    
  
</footer>


  </article>

  
    
<nav class='entry-nav'>
  <div class='entry-nav-links'><div class='prev-entry'>
      <a href='http://isaaclyman.com/blog/posts/logging-in/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader'>Previous post: </span>Logging in, a thing we all hate</a>
    </div><div class='next-entry'>
      <a href='http://isaaclyman.com/blog/posts/keyboard-buttons/'>
        <span class='screen-reader'>Next post: </span>A keyboard is not a list of buttons<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>


  

  
    <div class='comments-container'>
  
</div>

  
</main>

    <footer id='footer' class='footer-container'>
      <div class='footer'>
        <div class='social'>
  <nav aria-label='Social Menu'>
    <ul class='social-menu'></ul>
  </nav>
</div>

        <div class='copyright'>
          <p>© 2017 by Isaac Lyman. Site powered by Hugo and GitHub Pages.</p>

        </div>
      </div>
    </footer>

  </div>

  <script src='/blog/js/main.af838dd5.js'></script>
  
    <script src='/blog/js/custom.js'></script>
  

</body>

</html>

